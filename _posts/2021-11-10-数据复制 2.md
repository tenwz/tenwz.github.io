---
layout: post
title: 数据复制概念略要 
---

通过数据复制系统我们想要达到的目的

1. 容错，当部分组件出现故障，系统依然可以继续工作
2. 提高吞吐量，降低因为大量请求访问所带来的压力
3. 通过在地理位置上更接近用户，降低访问延迟

然而，想要达到以上目的会带来很多技术挑战。

---



由于业务在发展，数据也在持续更改，当有了多副本，不可避免的会引入一些问题，

- 如何确保所有副本之间的数据是一致的。
- 如何确保新的从节点和主节点保持数据一致
- 如果发生主、从节点失效，合适的解决方案是什么
- 如何选择合适的复制方式（日志）
- 如何保证最终一致性 -> 写后读一致性 -> 单调读一致性 -> 前缀读一致性 

---

## 如何确保所有副本之间的数据是一致的。



目前常见的解决方案是采用主从复制，主从复制的工作原理如下：

...

对于复制一个非常重要的考量是采用同步复制还是异步复制

同步复制的优点是...，

但是...。

在实际业务中，...

实践中，如果数据库启用了同步复制，往往指的是，....，这种配置有时也称为<u>半同步复制</u>

异步复制的优点是，...，

这种弱化的持久性听起来像是一个非常不靠谱的这种设计，但....还是被广泛使用



---

## 如何确保新的从节点和主节点保持数据一致

当如果出现以下情况：

- 增加副本数以提高容错能力
- 替换失败的副本

这时需要考略增加新的从节点，那么如何保证新的从节点和主从点保持数据一致

由于客户端可能仍然不断的向数据库写入数据，即数据始终处于不断变化之中。所以常规的文件拷贝方式会导致不同的节点上会呈现不同时间点的数据。

我们往往采用<u>一致性快照+数据更改日志</u>的方式来保证一致性，逻辑的主要操作如下：

...

---

## 如果发生主、从节点失效，合适的解决方案是什么

#### 从节点失效：追赶式恢复

#### 主节点失效：节点切换

选择某个从节点将其提升为主节点；客户端也应需要更新，这样之后的写请求会发送给新的主节点；其他从节点需要接收来自新的主节点的变更数据。此过程称为<u>切换</u>

故障切换有手动方式和自动方式。

手动方式如通知管理员主节点发生失效，采取必要的步骤来创建新的主节点。

自动方式的切换步骤如下：

1. 确认主节点失效。
2. 选举新的节点
3. 重新配置系统使主节点生效

确认主节点生效。有很多出错原因，如系统崩溃、停电、网络故障。没有万无一失的方法能够确切的检测问题会出在哪里，所以大多数系统都采用了基于<u>超时</u>的机制。节点间定时互相发送<u>心跳存活消息</u>，如果发现某节点在某一时间段中无响应，即认为该节点失效。

选举新节点。通过选举的方式（超过多数的节点达成共识）来选举新的主节点，或者由之前的选定的某控制节点来制定新的主节点。让所有节点同意新的主节点是<u>典型的共识问题</u>。

重新配置系统使新主节点生效。客户端需要将写请求发送给新的主节点（<u>请求路由</u>）。如果原主节点之后重新上线，可能仍然自以为是主节点，而没有意识到其他节点已经达成共识迫使其下台。此时系统应确保原主节点降级为从节点，并认可新的主节点。

尽管如此，自动切换过程仍充斥着许多变数。

- 如果在数据库之外有其他系统依赖于数据库的内容并在一切系统使用，丢弃数据的方案带来的风险就会放大。
- 脑裂。有些系统往往采取措施强制关闭其中一个节点，然而如果设计或实现考虑不周，可能会出现两个节点都被关闭。
- 如何设置合适的超时时间。超时时间过长意味着总体恢复时间过长。超时时间过短意味着可能会导致不必要的误判错误切换。





---

## 如何选择合适的复制方式（日志）

- 基于语句
- 基于预写日志
- 基于行的逻辑日志

...



---

## 复制滞后问题





最终一致性

写后读一致性是指...

基于主从复制的系统的可行方案有

- 如果用户可能会被修改的内容，从主节点读取；否则在从节点读取。举个例子，社交网络上的用户首页信息通常只能由所有者编辑，那么我们可以：总是从主节点读取用户自己的首页配置文件，而在从节点读取其他用户的配置文件
- 跟踪最近更新的时间。比如，如果修改的内容在更新后一分钟之内，则总是在主节点读取；并监控从节点的复制滞后程度，避免从那些滞后时间超过一分钟的从节点读取。
- 记住客户端最近更新时的时间戳，并附在读请求中。系统可以根据此信息，确保对该用户提供读服务时，都应该至少包含了该时间戳的更新。如果不够新，可以交给另一个副本处理，也可以等待到该副本接收到了最近的更新，时间戳可以是逻辑时间戳（比如用来指示写入顺序的日志序列号）或实际系统时间。
- 跨设备的写后读一致性 ...

单调读是指...

实现单调读的一种方式时，确保每个用户总是从固定的同一副本执行读取，而不同的用户可以从不同的副本读取。例如，基于用户 ID 哈希。如果该副本发生失效，则用户的查询必须重新路由到另一个副本。

前缀一致读是指..





敲了三千多字...服了，改天再补..