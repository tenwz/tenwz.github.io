---
layout: post
title: 男女性别加索引真的是反面教材吗？




---

**背景**

每次操作将历史记录标识位全部改成“已过期”，再将新结果插入到数据表中。“在大量执行update操作”指的就是批量更新标识位的操作。大概一次操作要更新几十万条，然后插入几条。一次更新要执行几十秒。

**问题解决**

同事提出要加索引解决。第一反应：最主要的字段只有两个值：“已过期”、“未过期”。对这种字段加索引是不是没什么用？结果实际测试结果是：不加这条索引十几秒执行完的查询和更新操作，加了索引只要几毫秒。

**原理分析**

**为什么这条索引有效？**

先说为什么我第一反应觉得不会很有效

![图片](https://mmbiz.qpic.cn/mmbiz_png/2tk5ianItRlibsicbHxHNficSEZrSPTPlg887gorEmFNlVsu5UCZcr88tzLRYD2C89fFHBrvzLcRqiaMEQ4hToycHTQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/2tk5ianItRlibsicbHxHNficSEZrSPTPlg88upamLYZAiauqfu1sI87pJ2WCm4y48iaB6MUbW34geVMhRSy8icLBnTkHA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**那么为什么能提高查询速度。**

举个例子，假设表中有一千万条记录，状态字段有0和1两个值。某个状态为0的记录总数大概会有100条，那么你想查询状态为0的记录时，有没有索引影响非常大，而查询状态为1的记录，则索引基本无用。如果两种状态的记录数相差无几的话，索引也基本无用。

所有的关于索引的文章，建议你不要为这种字段建索引的依据，都是以<u>**值分布是均匀**</u>为前提的。

但如果值分布不均匀的时候，这个建议就不一定是正确的了。当我们需要查询的记录恰好是分布较少的记录的时候，值分布越是不均匀，索引就越有价值！

**那为什么能提高更新速度呢？**

对于update/insert/delete的每次执行，字段的索引都必须重新计算更新。听起来很慢，但是更新操作实际上是先select再update的过程，这里因为“未过期”数据条数很少，所以select效率高，然后更新是按照id进行更新，所以很快。





---

