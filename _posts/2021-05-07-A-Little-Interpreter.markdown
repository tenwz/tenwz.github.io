---
layout: post
title: A Little Interpreter
---



å­¦ä¹ å®ç°è¯­è¨€ï¼Œæœ€å¥½ä»æœ€ç®€å•ï¼Œæœ€å¹²å‡€çš„è¯­è¨€å¼€å§‹ï¼Œè¿…é€Ÿå†™å‡ºä¸€ä¸ªå¯ç”¨çš„è§£é‡Šå™¨ã€‚ä¹‹åå†é€æ­¥å¾€é‡Œé¢æ·»åŠ ç‰¹æ€§ï¼ŒåŒæ—¶ä¿æŒæ­£ç¡®ã€‚è¿™æ ·æ‰èƒ½æœ‰æ¡ä¸ç´Šåœ°æ„é€ å‡ºå¤æ‚çš„è§£é‡Šå™¨ã€‚

æˆ‘ä»¬é‡‡ç”¨schemeè¯­è¨€ã€‚

æˆ‘ä»¬å°†å®ç°ä¸€ä¸ªç®€å•çš„è§£é‡Šå™¨ï¼Œåå«â€œR2â€ã€‚å®ƒå¯ä»¥ä½œä¸ºä¸€ä¸ªç®€å•çš„è®¡ç®—å™¨ç”¨ï¼Œå¹¶ä¸”å…·æœ‰å˜é‡å®šä¹‰ï¼Œå‡½æ•°å®šä¹‰å’Œè°ƒç”¨åŠŸèƒ½ã€‚

------

#### é¢„å¤‡çŸ¥è¯†

schemeè¯­è¨€ï¼Œæ¨¡å¼åŒ¹é…ï¼ŒSè¡¨è¾¾å¼ï¼Œé€’å½’ï¼Œé—­åŒ…ï¼ŒæŠ½è±¡è¯­æ³•æ ‘

------

#### è®¡ç®—å™¨

ä½ å°†å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½

```scheme
(calc '(+ 1 2))
;; => 3
(calc '(* 2 3))
;; => 6
(calc '(* (+ 1 2) (+ (/ 6 2) 4)))
;; => 21
```

```scheme
#lang racket                                  ; å£°æ˜ç”¨ Racket è¯­è¨€

(define calc
  (lambda (exp)
    (match exp                                ; åˆ†æ”¯åŒ¹é…ï¼šè¡¨è¾¾å¼çš„ä¸¤ç§æƒ…å†µ
      [(? number? x) x]                       ; æ˜¯æ•°å­—ï¼Œç›´æ¥è¿”å›
      [`(,op ,e1 ,e2)                         ; åŒ¹é…æå–æ“ä½œç¬¦opå’Œä¸¤ä¸ªæ“ä½œæ•°e1,e2
       (let ([v1 (calc e1)]                   ; é€’å½’è°ƒç”¨ calc è‡ªå·±ï¼Œå¾—åˆ° e1 çš„å€¼
             [v2 (calc e2)])                  ; é€’å½’è°ƒç”¨ calc è‡ªå·±ï¼Œå¾—åˆ° e2 çš„å€¼
         (match op                            ; åˆ†æ”¯åŒ¹é…ï¼šæ“ä½œç¬¦ op çš„ 4 ç§æƒ…å†µ
           ['+ (+ v1 v2)]                     ; å¦‚æœæ˜¯åŠ å·ï¼Œè¾“å‡ºç»“æœä¸º (+ v1 v2)
           ['- (- v1 v2)]                     ; å¦‚æœæ˜¯å‡å·ï¼Œä¹˜å·ï¼Œé™¤å·ï¼Œç›¸ä¼¼çš„å¤„ç†
           ['* (* v1 v2)]
           ['/ (/ v1 v2)]))])))
```

------

### R2: ä¸€ä¸ªå¾ˆå°çš„ç¨‹åºè¯­è¨€

ä½ å°†å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

- å˜é‡ï¼šx
- å‡½æ•°ï¼š(lambda (x) e)
- ç»‘å®šï¼š(let ([x e1]) e2)
- è°ƒç”¨ï¼š(e1 e2)
- ç®—æœ¯ï¼š(â€¢ e2 e2)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè·Ÿä¸€èˆ¬è¯­è¨€ä¸åŒï¼Œæˆ‘ä»¬çš„å‡½æ•°åªæ¥å—ä¸€ä¸ªå‚æ•°ã€‚è¿™ä¸æ˜¯ä¸€ä¸ªä¸¥é‡çš„é™åˆ¶ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„è¯­è¨€é‡Œï¼Œ<u>å‡½æ•°å¯ä»¥è¢«ä½œä¸ºå€¼ä¼ é€’</u>ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“â€œ<u>first-class function</u>â€ã€‚æ‰€ä»¥ä½ å¯ä»¥ç”¨åµŒå¥—çš„å‡½æ•°å®šä¹‰æ¥è¡¨ç¤ºæœ‰ä¸¤ä¸ªä»¥ä¸Šå‚æ•°çš„å‡½æ•°ã€‚

<u>ä¸‹é¢æ˜¯æ¼”ç¤ºä¾‹å­ï¼Œä»£ç è¡Œæ•°å¾ˆå°‘ï¼Œä½†æ˜¯å®ƒå·²ç»å®Œå…¨å¯ä»¥å¤„ç†ä¸€ä¸ªç›¸å½“å¼ºå¤§çš„å‡½æ•°å¼è¯­è¨€ã€‚</u>

```scheme
(r2 '(+ 1 2))
;; => 3

(r2 '(* 2 3))
;; => 6

(r2 '(* 2 (+ 3 4)))
;; => 14

(r2 '(* (+ 1 2) (+ 3 4)))
;; => 21

(r2 '((lambda (x) (* 2 x)) 3))
;; => 6

(r2
'(let ([x 2])
   (let ([f (lambda (y) (* x y))])
     (f 3))))
;; => 6

(r2
'(let ([x 2])
   (let ([f (lambda (y) (* x y))])
     (let ([x 4])
       (f 3)))))
;; => 6
```

------

#### å¯¹åŸºæœ¬ç®—æœ¯æ“ä½œçš„è§£é‡Šä¸å®ç°

```scheme
(match exp
  ... ...
  [`(,op ,e1 ,e2)
   (let ([v1 (interp e1 env)]             ; é€’å½’è°ƒç”¨ interp è‡ªå·±ï¼Œå¾—åˆ° e1 çš„å€¼
         [v2 (interp e2 env)])            ; é€’å½’è°ƒç”¨ interp è‡ªå·±ï¼Œå¾—åˆ° e2 çš„å€¼
     (match op                            ; åˆ†æ”¯ï¼šå¤„ç†æ“ä½œç¬¦ op çš„ 4 ç§æƒ…å†µ
       ['+ (+ v1 v2)]                     ; å¦‚æœæ˜¯åŠ å·ï¼Œè¾“å‡ºç»“æœä¸º (+ v1 v2)
       ['- (- v1 v2)]                     ; å¦‚æœæ˜¯å‡å·ï¼Œä¹˜å·ï¼Œé™¤å·ï¼Œç›¸ä¼¼çš„å¤„ç†
       ['* (* v1 v2)]
       ['/ (/ v1 v2)]))])
```

------

#### å¯¹æ•°å­—çš„è§£é‡Šä¸å®ç°

```scheme
[(? number? x) x]
```

------

#### å¯¹å˜é‡ã€å‡½æ•°çš„è§£é‡Šä¸å®ç°

- å¯¹å˜é‡æœ€åŸºæœ¬çš„æ“ä½œï¼Œæ˜¯å¯¹å®ƒçš„â€œç»‘å®šâ€ï¼ˆbindingï¼‰å’Œâ€œå–å€¼â€ï¼ˆevaluateï¼‰

- æˆ‘ä»¬é€šè¿‡â€œç¯å¢ƒâ€ï¼Œæ¥è®°å½•å˜é‡çš„å€¼ï¼Œå¹¶ä¸”æŠŠå®ƒä»¬ä¼ é€’åˆ°å˜é‡çš„â€œå¯è§åŒºåŸŸâ€ã€‚å˜é‡çš„å¯è§åŒºåŸŸï¼Œç”¨æœ¯è¯­è¯´å«åšâ€œä½œç”¨åŸŸâ€ï¼ˆscopeï¼‰
- ç¯å¢ƒæ˜¯ä¸€ä¸ªå †æ ˆï¼ˆstackï¼‰ã€‚å†…å±‚çš„ç»‘å®šï¼Œä¼šå‡ºç°åœ¨ç¯å¢ƒçš„æœ€ä¸Šé¢ï¼Œè¿™å°±æ˜¯åœ¨â€œå‹æ ˆâ€ã€‚è¿™æ ·æˆ‘ä»¬æŸ¥æ‰¾å˜é‡çš„æ—¶å€™ï¼Œä¼šä¼˜å…ˆæ‰¾åˆ°æœ€å†…å±‚å®šä¹‰çš„å˜é‡ã€‚
- ç¯å¢ƒè¢«æ‰©å±•ä»¥åï¼Œå½¢æˆäº†ä¸€ä¸ªæ–°çš„ç¯å¢ƒï¼Œè€ŒåŸæ¥çš„ç¯å¢ƒå¹¶æ²¡æœ‰è¢«æ”¹å˜ã€‚å½“æˆ‘ä»¬æ‰©å±•ä¸€ä¸ªç¯å¢ƒï¼Œè¿›å…¥é€’å½’ï¼Œè¿”å›ä¹‹åï¼Œå¤–å±‚çš„ä»£ç å¿…é¡»ä»ç„¶å¯ä»¥è®¿é—®åŸæ¥å¤–å±‚çš„ç¯å¢ƒã€‚

**ç¯å¢ƒçš„è§£é‡Šä¸å®ç°**

```scheme
;; ç©ºç¯å¢ƒ
(define env0 '())

;; å¯¹ç¯å¢ƒ env è¿›è¡Œæ‰©å±•ï¼ŒæŠŠ x æ˜ å°„åˆ° v
(define ext-env
  (lambda (x v env)
    (cons `(,x . ,v) env)))

;; å–å€¼ã€‚åœ¨ç¯å¢ƒä¸­ env ä¸­æŸ¥æ‰¾ x çš„å€¼
(define lookup
  (lambda (x env)
    (let ([p (assq x env)])
      (cond
       [(not p) #f]
       [else (cdr p)]))))
```

ä½ éœ€è¦ç†è§£è¿™ä¸ªä¾‹å­

```scheme
(let ([x 1])         ; env='()ã€‚ç»‘å®šxåˆ°1ã€‚
  (let ([y 2])       ; env='((x . 1))ã€‚ç»‘å®šyåˆ°2ã€‚
    (let ([x 3])     ; env='((y . 2) (x . 1))ã€‚ç»‘å®šxåˆ°3ã€‚
      (+ x y))))     ; env='((x . 3) (y . 2) (x . 1))ã€‚æŸ¥æ‰¾xï¼Œå¾—åˆ°3ï¼›æŸ¥æ‰¾yï¼Œå¾—åˆ°2ã€‚
;; => 5
```



å˜é‡çš„è§£é‡Šä¸å®ç°

```scheme
[(? symbol? x) (lookup x env)]			;åœ¨ç¯å¢ƒä¸­ï¼Œæ²¿ç€ä»å†…å‘å¤–çš„â€œä½œç”¨åŸŸé¡ºåºâ€ï¼ŒæŸ¥æ‰¾å˜é‡çš„å€¼
```



ç»‘å®šçš„è§£é‡Šä¸å®ç°

```scheme
[`(let ([,x ,e1]) ,e2)                           
 (let ([v1 (interp e1 env)])              ; è§£é‡Šå³è¾¹è¡¨è¾¾å¼e1ï¼Œå¾—åˆ°å€¼v1
   (interp e2 (ext-env x v1 env)))]       ; æŠŠ(x . v1)æ‰©å……åˆ°ç¯å¢ƒé¡¶éƒ¨ï¼Œå¯¹e2æ±‚å€¼
```



**æ·±åˆ»ç†è§£ä½œç”¨åŸŸ**

- ä½ éœ€è¦ç†è§£ä¸ºä»€ä¹ˆæ­¤å¤„çš„ç­”æ¡ˆæ˜¯ 6 ï¼ˆLexical Scoping ï¼‰è€Œä¸æ˜¯ 12 ï¼ˆDynamic Scopingï¼‰
- ä½ éœ€è¦ç†è§£ä¸¤ç§ä¸åŒçš„è®¾è®¡ä¼šå¸¦æ¥æ€æ ·çš„å½±å“

```scheme
(let ([x 2])
  (let ([f (lambda (y) (* x y))])
    (let ([x 4])
      (f 3))))

;; => 6
```



å¯¹å‡½æ•°çš„è§£é‡Šä¸å®ç°

- ä¸ºäº†å®ç° lexical scopingï¼Œæˆ‘ä»¬å¿…é¡»æŠŠå‡½æ•°åšæˆâ€œé—­åŒ…â€ï¼ˆclosureï¼‰ã€‚

- é—­åŒ…æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œå®ƒç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆï¼šå‡½æ•°çš„å®šä¹‰å’Œå½“å‰çš„ç¯å¢ƒã€‚

- ```scheme
  (struct Closure (f env))
  ```

```scheme
;;å¯¹ (lambda (x) e) çš„è§£é‡Š
[`(lambda (,x) ,e)
 (Closure exp env)]
```

------

### å¯¹è°ƒç”¨çš„è§£é‡Š

```scheme
[`(,e1 ,e2)                                            
 (let ([v1 (interp e1 env)]             ; è®¡ç®—å‡½æ•° e1 çš„å€¼
       [v2 (interp e2 env)])            ; è®¡ç®—å‚æ•° e2 çš„å€¼
   (match v1
     [(Closure `(lambda (,x) ,e) env-save)      ; ç”¨æ¨¡å¼åŒ¹é…çš„æ–¹å¼å–å‡ºé—­åŒ…é‡Œçš„å„ä¸ªå­ç»“æ„
      (interp e (ext-env x v2 env-save))]))]    ; åœ¨é—­åŒ…çš„ç¯å¢ƒenv-saveä¸­æŠŠxç»‘å®šåˆ°v2ï¼Œè§£é‡Šå‡½æ•°ä½“     

```

ä½ éœ€è¦æ€è€ƒï¼š

<u>å¦‚æœæŠŠ env-save æ”¹æˆ env å‡½æ•°çš„è°ƒç”¨ä¼šå‘ç”Ÿæ€æ ·çš„å˜åŒ–ï¼Ÿ</u>

<u>æ—©æœŸçš„ Lisp è¯­è¨€ï¼Œæ¯”å¦‚ Emacs Lispï¼Œéƒ½ä½¿ç”¨ dynamic scopingï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ</u>

<u>ç¯å¢ƒä½¿ç”¨å‡½æ•°å¼æ•°æ®ç»“æ„çš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿ</u>

------

### å®Œæ•´ä»£ç 

```scheme
#lang racket

;;; ä»¥ä¸‹ä¸‰ä¸ªå®šä¹‰ env0, ext-env, lookup æ˜¯å¯¹ç¯å¢ƒï¼ˆenvironmentï¼‰çš„åŸºæœ¬æ“ä½œï¼š

;; ç©ºç¯å¢ƒ
(define env0 '())

;; æ‰©å±•ã€‚å¯¹ç¯å¢ƒ env è¿›è¡Œæ‰©å±•ï¼ŒæŠŠ x æ˜ å°„åˆ° vï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ç¯å¢ƒ
(define ext-env
  (lambda (x v env)
    (cons `(,x . ,v) env)))

;; æŸ¥æ‰¾ã€‚åœ¨ç¯å¢ƒä¸­ env ä¸­æŸ¥æ‰¾ x çš„å€¼ã€‚å¦‚æœæ²¡æ‰¾åˆ°å°±è¿”å› #f
(define lookup
  (lambda (x env)
    (let ([p (assq x env)])
      (cond
       [(not p) #f]
       [else (cdr p)]))))
       
;; é—­åŒ…çš„æ•°æ®ç»“æ„å®šä¹‰ï¼ŒåŒ…å«ä¸€ä¸ªå‡½æ•°å®šä¹‰ f å’Œå®ƒå®šä¹‰æ—¶æ‰€åœ¨çš„ç¯å¢ƒ
(struct Closure (f env))

;; è§£é‡Šå™¨çš„é€’å½’å®šä¹‰ï¼ˆæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œè¡¨è¾¾å¼ exp å’Œç¯å¢ƒ envï¼‰
;; å…± 5 ç§æƒ…å†µï¼ˆå˜é‡ï¼Œå‡½æ•°ï¼Œç»‘å®šï¼Œè°ƒç”¨ï¼Œæ•°å­—ï¼Œç®—æœ¯è¡¨è¾¾å¼ï¼‰
(define interp
  (lambda (exp env)
    (match exp                                          ; å¯¹expè¿›è¡Œæ¨¡å¼åŒ¹é…
      [(? symbol? x)                                    ; å˜é‡
       (let ([v (lookup x env)])
         (cond
          [(not v)
           (error "undefined variable" x)]
          [else v]))]      
      [(? number? x) x]                                 ; æ•°å­—
      [`(lambda (,x) ,e)                                ; å‡½æ•°
       (Closure exp env)]
      [`(let ([,x ,e1]) ,e2)                            ; ç»‘å®š
       (let ([v1 (interp e1 env)])
         (interp e2 (ext-env x v1 env)))]
      [`(,e1 ,e2)                                       ; è°ƒç”¨
       (let ([v1 (interp e1 env)]
             [v2 (interp e2 env)])
         (match v1
           [(Closure `(lambda (,x) ,e) env-save)
            (interp e (ext-env x v2 env-save))]))]
      [`(,op ,e1 ,e2)                                   ; ç®—æœ¯è¡¨è¾¾å¼
       (let ([v1 (interp e1 env)]
             [v2 (interp e2 env)])
         (match op
           ['+ (+ v1 v2)]
           ['- (- v1 v2)]
           ['* (* v1 v2)]
           ['/ (/ v1 v2)]))])))

;; è§£é‡Šå™¨çš„â€œç”¨æˆ·ç•Œé¢â€å‡½æ•°ã€‚å®ƒæŠŠ interp åŒ…è£…èµ·æ¥ï¼Œæ©ç›–ç¬¬äºŒä¸ªå‚æ•°ï¼Œåˆå§‹å€¼ä¸º env0
(define r2
  (lambda (exp)
    (interp exp env0)))
```





------

ä¸€ç‚¹é­”æ³•ğŸª„

```scheme
(let ([x e1]) e2) 
```

ä¸ä»¥ä¸‹å®Œå…¨ç­‰ä»·ã€‚

```scheme
((lambda (x) e2) e1)
```

